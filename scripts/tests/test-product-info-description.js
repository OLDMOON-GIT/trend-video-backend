const fs = require('fs');
const path = require('path');

let testResults = { passed: 0, failed: 0, tests: [] };

function addTestResult(name, passed, message) {
  testResults.tests.push({ name, passed, message });
  if (passed) {
    testResults.passed++;
    console.log(`âœ… ${name}: ${message}`);
  } else {
    testResults.failed++;
    console.error(`âŒ ${name}: ${message}`);
  }
}

async function runTests() {
  console.log('ğŸ§ª ìƒí’ˆì •ë³´ ëŒ€ë³¸ â†’ YouTube ì„¤ëª…ë€ ì—°ë™ í…ŒìŠ¤íŠ¸\n');

  const uploadPath = path.join(__dirname, 'trend-video-frontend', 'src', 'app', 'api', 'youtube', 'upload', 'route.ts');
  const uploadContent = fs.readFileSync(uploadPath, 'utf-8');

  // í…ŒìŠ¤íŠ¸ 1: ìƒí’ˆì •ë³´ ëŒ€ë³¸ ì°¾ê¸° ë¡œì§ ì¡´ì¬
  const hasProductInfoQuery = uploadContent.includes('SELECT content FROM scripts') &&
                               uploadContent.includes('ìƒí’ˆ ê¸°ì… ì •ë³´') &&
                               uploadContent.includes('product-info');
  addTestResult('ìƒí’ˆì •ë³´ ëŒ€ë³¸ ì¡°íšŒ ë¡œì§', hasProductInfoQuery,
    hasProductInfoQuery ? 'DB ì¿¼ë¦¬ ì¡´ì¬' : 'DB ì¿¼ë¦¬ ëˆ„ë½');

  // í…ŒìŠ¤íŠ¸ 2: title íŒ¨í„´ ë§¤ì¹­
  const hasTitlePattern = uploadContent.includes('title LIKE ?') &&
                          uploadContent.includes('%${job.title}%ìƒí’ˆ ê¸°ì… ì •ë³´%');
  addTestResult('title íŒ¨í„´ ë§¤ì¹­', hasTitlePattern,
    hasTitlePattern ? '"{ì œëª©} - ìƒí’ˆ ê¸°ì… ì •ë³´" íŒ¨í„´ ë§¤ì¹­' : 'íŒ¨í„´ ë§¤ì¹­ ëˆ„ë½');

  // í…ŒìŠ¤íŠ¸ 3: user_id í•„í„°ë§
  const hasUserFilter = uploadContent.includes('WHERE user_id = ?') ||
                        uploadContent.includes('user_id = ?');
  addTestResult('user_id í•„í„°ë§', hasUserFilter,
    hasUserFilter ? 'ê°™ì€ ì‚¬ìš©ìì˜ ìŠ¤í¬ë¦½íŠ¸ë§Œ ê²€ìƒ‰' : 'í•„í„°ë§ ëˆ„ë½');

  // í…ŒìŠ¤íŠ¸ 4: ìµœì‹ ìˆœ ì •ë ¬
  const hasOrderBy = uploadContent.includes('ORDER BY created_at DESC');
  addTestResult('ìµœì‹ ìˆœ ì •ë ¬', hasOrderBy,
    hasOrderBy ? 'ê°€ì¥ ìµœê·¼ ìƒí’ˆì •ë³´ ëŒ€ë³¸ ì‚¬ìš©' : 'ì •ë ¬ ëˆ„ë½');

  // í…ŒìŠ¤íŠ¸ 5: autoGeneratedDescriptionì— í• ë‹¹
  const assignsToAutoDesc = uploadContent.includes('autoGeneratedDescription = productInfoScript.content');
  addTestResult('description í• ë‹¹', assignsToAutoDesc,
    assignsToAutoDesc ? 'productInfoScript.content â†’ autoGeneratedDescription' : 'í• ë‹¹ ëˆ„ë½');

  // í…ŒìŠ¤íŠ¸ 6: ì—ëŸ¬ ì²˜ë¦¬
  const hasErrorHandling = uploadContent.includes('catch (dbError)') &&
                           uploadContent.includes('ìƒí’ˆì •ë³´ ëŒ€ë³¸ ë¡œë“œ ì‹¤íŒ¨');
  addTestResult('ì—ëŸ¬ ì²˜ë¦¬', hasErrorHandling,
    hasErrorHandling ? 'DB ì—ëŸ¬ ì²˜ë¦¬ ë¡œì§ ì¡´ì¬' : 'ì—ëŸ¬ ì²˜ë¦¬ ëˆ„ë½');

  // í…ŒìŠ¤íŠ¸ 7: ëŒ€ì²´ ì„¤ëª… (fallback)
  const hasFallback = uploadContent.includes('ìƒí’ˆì •ë³´ ëŒ€ë³¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ') &&
                      uploadContent.includes('ê¸°ë³¸ ì„¤ëª… ì‚¬ìš©');
  addTestResult('ëŒ€ì²´ ì„¤ëª… (fallback)', hasFallback,
    hasFallback ? 'ìƒí’ˆì •ë³´ ì—†ì„ ë•Œ ê¸°ë³¸ ì„¤ëª… ì‚¬ìš©' : 'fallback ëˆ„ë½');

  // í…ŒìŠ¤íŠ¸ 8: DB connection close
  const hasDbClose = uploadContent.includes('db.close()');
  addTestResult('DB connection close', hasDbClose,
    hasDbClose ? 'DB ì—°ê²° ì •ë¦¬' : 'close() ëˆ„ë½ (ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ìœ„í—˜)');

  // ê²°ê³¼ ìš”ì•½
  console.log('\n' + '='.repeat(60));
  console.log(`âœ… í†µê³¼: ${testResults.passed}/${testResults.tests.length}`);
  console.log(`âŒ ì‹¤íŒ¨: ${testResults.failed}/${testResults.tests.length}`);
  console.log('='.repeat(60));

  if (testResults.failed > 0) {
    console.log('\nğŸ” ì‹¤íŒ¨í•œ í…ŒìŠ¤íŠ¸:');
    testResults.tests.filter(t => !t.passed).forEach(t => {
      console.log(`  - ${t.name}: ${t.message}`);
    });
  } else {
    console.log('\nâœ… ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼!');
    console.log('\nğŸ“‹ êµ¬í˜„ëœ ê¸°ëŠ¥:');
    console.log('  1. job.type === "product"ì¼ ë•Œ ìƒí’ˆì •ë³´ ëŒ€ë³¸ ê²€ìƒ‰');
    console.log('  2. ê²€ìƒ‰ ì¡°ê±´:');
    console.log('     - ê°™ì€ user_id');
    console.log('     - titleì— job.title í¬í•¨');
    console.log('     - titleì— "ìƒí’ˆ ê¸°ì… ì •ë³´" ë˜ëŠ” "product-info" í¬í•¨');
    console.log('  3. ìµœì‹  ìƒí’ˆì •ë³´ ëŒ€ë³¸ ì‚¬ìš© (ORDER BY created_at DESC)');
    console.log('  4. contentë¥¼ YouTube descriptionì— ì„¤ì •');
    console.log('  5. ëª» ì°¾ìœ¼ë©´ ê¸°ë³¸ ì„¤ëª… ì‚¬ìš©');
    console.log('\nğŸ’¡ ìƒí’ˆì •ë³´ ëŒ€ë³¸ì´ í¬í•¨í•´ì•¼ í•  ë‚´ìš©:');
    console.log('  - ìƒí’ˆëª…');
    console.log('  - ì¿ íŒ¡ ë”¥ë§í¬ (íŒŒíŠ¸ë„ˆìŠ¤ ë§í¬)');
    console.log('  - ìƒí’ˆ ì„¤ëª…/íŠ¹ì§•');
    console.log('  - êµ¬ë§¤ ì•ˆë‚´');
    console.log('\nâš ï¸ ì£¼ì˜ì‚¬í•­:');
    console.log('  - ìƒí’ˆì •ë³´ ëŒ€ë³¸ì´ ë¯¸ë¦¬ ìƒì„±ë˜ì–´ ìˆì–´ì•¼ í•¨');
    console.log('  - ëŒ€ë³¸ ì œëª© í˜•ì‹: "{ìƒí’ˆëª…} - ìƒí’ˆ ê¸°ì… ì •ë³´"');
  }

  process.exit(testResults.failed === 0 ? 0 : 1);
}

runTests().catch(error => {
  console.error('âŒ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì˜¤ë¥˜:', error);
  process.exit(1);
});
