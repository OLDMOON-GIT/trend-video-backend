"""
Douyin ì¿ í‚¤ ì¶”ì¶œ í—¬í¼
Seleniumìœ¼ë¡œ ë¸Œë¼ìš°ì €ë¥¼ ì—´ê³  ì‚¬ìš©ìê°€ ë¡œê·¸ì¸í•˜ë©´ ìë™ìœ¼ë¡œ ì¿ í‚¤ë¥¼ ì €ì¥í•©ë‹ˆë‹¤.
"""
from selenium import webdriver
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.chrome.options import Options
from webdriver_manager.chrome import ChromeDriverManager
import time
from pathlib import Path
import json


def extract_douyin_cookies(output_file: Path):
    """
    Douyin ì¿ í‚¤ ì¶”ì¶œ

    Args:
        output_file: ì¿ í‚¤ë¥¼ ì €ì¥í•  íŒŒì¼ ê²½ë¡œ
    """
    print("=" * 80)
    print("ğŸª Douyin ì¿ í‚¤ ì¶”ì¶œ í—¬í¼")
    print("=" * 80)
    print()
    print("âœ‹ ì ì‹œ í›„ ë¸Œë¼ìš°ì €ê°€ ì—´ë¦½ë‹ˆë‹¤.")
    print("ğŸ“ Douyin(æŠ–éŸ³) ì‚¬ì´íŠ¸ì—ì„œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.")
    print("â° ë¡œê·¸ì¸ í›„ 30ì´ˆ ëŒ€ê¸° í›„ ìë™ìœ¼ë¡œ ì¿ í‚¤ë¥¼ ì €ì¥í•©ë‹ˆë‹¤.")
    print()

    # Chrome ì˜µì…˜ ì„¤ì •
    chrome_options = Options()
    chrome_options.add_argument('--disable-blink-features=AutomationControlled')
    chrome_options.add_experimental_option("excludeSwitches", ["enable-automation"])
    chrome_options.add_experimental_option('useAutomationExtension', False)

    # Chrome ë“œë¼ì´ë²„ ì‹œì‘
    print("ğŸš€ Chrome ë¸Œë¼ìš°ì € ì‹œì‘ ì¤‘...")
    driver = webdriver.Chrome(
        service=Service(ChromeDriverManager().install()),
        options=chrome_options
    )

    try:
        # Douyin ì—´ê¸°
        print("ğŸŒ Douyin ì‚¬ì´íŠ¸ ì ‘ì† ì¤‘: https://www.douyin.com")
        driver.get("https://www.douyin.com")

        print()
        print("=" * 80)
        print("â³ ì§€ê¸ˆ ë¸Œë¼ìš°ì €ì—ì„œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”!")
        print("=" * 80)
        print()
        print("ğŸ“± ë¡œê·¸ì¸ ë°©ë²•:")
        print("  1. QR ì½”ë“œ ìŠ¤ìº”ìœ¼ë¡œ ë¡œê·¸ì¸")
        print("  2. ë˜ëŠ” ì „í™”ë²ˆí˜¸/ì´ë©”ì¼ë¡œ ë¡œê·¸ì¸")
        print()
        print("â° ë¡œê·¸ì¸ í›„ 30ì´ˆ ë™ì•ˆ ëŒ€ê¸°í•©ë‹ˆë‹¤...")
        print()

        # 30ì´ˆ ëŒ€ê¸° (ì‚¬ìš©ìê°€ ë¡œê·¸ì¸í•  ì‹œê°„)
        for i in range(30, 0, -1):
            print(f"\râ³ ë‚¨ì€ ì‹œê°„: {i}ì´ˆ...", end="", flush=True)
            time.sleep(1)

        print("\n")
        print("=" * 80)
        print("ğŸª ì¿ í‚¤ ì¶”ì¶œ ì¤‘...")
        print("=" * 80)
        print()

        # ì¿ í‚¤ ê°€ì ¸ì˜¤ê¸°
        cookies = driver.get_cookies()

        if not cookies:
            print("âŒ ì¿ í‚¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¡œê·¸ì¸ì´ ì œëŒ€ë¡œ ë˜ì§€ ì•Šì•˜ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
            return False

        # Netscape ì¿ í‚¤ í˜•ì‹ìœ¼ë¡œ ë³€í™˜ (yt-dlpê°€ ì‚¬ìš©í•˜ëŠ” í˜•ì‹)
        output_file.parent.mkdir(parents=True, exist_ok=True)

        with open(output_file, 'w', encoding='utf-8') as f:
            # Netscape HTTP Cookie File í—¤ë”
            f.write("# Netscape HTTP Cookie File\n")
            f.write("# This file was generated by Douyin Cookie Extractor\n")
            f.write("# Edit at your own risk.\n\n")

            for cookie in cookies:
                domain = cookie.get('domain', '')
                flag = 'TRUE' if domain.startswith('.') else 'FALSE'
                path = cookie.get('path', '/')
                secure = 'TRUE' if cookie.get('secure', False) else 'FALSE'
                expiration = str(int(cookie.get('expiry', 0))) if 'expiry' in cookie else '0'
                name = cookie.get('name', '')
                value = cookie.get('value', '')

                # Netscape í˜•ì‹: domain flag path secure expiration name value
                f.write(f"{domain}\t{flag}\t{path}\t{secure}\t{expiration}\t{name}\t{value}\n")

        print(f"âœ… ì¿ í‚¤ ì €ì¥ ì™„ë£Œ: {output_file}")
        print(f"ğŸ“Š ì´ {len(cookies)}ê°œì˜ ì¿ í‚¤ ì €ì¥ë¨")
        print()
        print("=" * 80)
        print("ğŸ‰ ì¿ í‚¤ ì¶”ì¶œ ì„±ê³µ!")
        print("=" * 80)
        print()
        print("ğŸ’¡ ì´ì œ Douyin ì˜ìƒì„ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!")
        print()

        return True

    except Exception as e:
        print(f"\nâŒ ì˜¤ë¥˜ ë°œìƒ: {e}")
        import traceback
        traceback.print_exc()
        return False

    finally:
        print("ğŸ”’ ë¸Œë¼ìš°ì € ì¢…ë£Œ ì¤‘...")
        driver.quit()
        print("âœ… ì™„ë£Œ!")


def main():
    """ë©”ì¸ í•¨ìˆ˜"""
    # ì¿ í‚¤ ì €ì¥ ê²½ë¡œ
    output_file = Path(__file__).parent.parent.parent / "douyin_downloads" / "cookies.txt"

    print()
    print("ğŸ“ ì¿ í‚¤ ì €ì¥ ê²½ë¡œ:", output_file)
    print()

    # ì¿ í‚¤ ì¶”ì¶œ
    success = extract_douyin_cookies(output_file)

    if success:
        print("\nâœ… ì¿ í‚¤ ì¶”ì¶œì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!")
        print(f"ğŸ“ íŒŒì¼ ìœ„ì¹˜: {output_file}")
        print()
        print("ğŸ¬ ì´ì œ Douyin ì˜ìƒì„ ë‹¤ìš´ë¡œë“œí•´ë³´ì„¸ìš”!")
    else:
        print("\nâŒ ì¿ í‚¤ ì¶”ì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")
        print("ğŸ’¡ ë‹¤ì‹œ ì‹œë„í•˜ê±°ë‚˜, ìˆ˜ë™ìœ¼ë¡œ ì¿ í‚¤ë¥¼ ì¶”ì¶œí•´ì£¼ì„¸ìš”.")


if __name__ == "__main__":
    main()
